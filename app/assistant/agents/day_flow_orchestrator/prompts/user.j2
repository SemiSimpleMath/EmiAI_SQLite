**Current Time:** {{ date_time }}
**Day:** {{ day_of_week }}
{% if entity_info %}
**Entity Context**:
{{ entity_info }}
{% endif %}
{% if location_summary and location_summary != "Currently: Unknown" %}
**Location:** {{ location_summary }}
{% endif %}
{% if resource_weather and resource_weather.current %}
**Weather:** {{ resource_weather.location.city }}: {{ resource_weather.current.temperature }}°F, {{ resource_weather.current.condition }}
{% endif %}

{% if resource_daily_context_generator_output and (resource_daily_context_generator_output.day_theme or resource_daily_context_generator_output.milestones) %}
---

## Daily Context
*This captures the main themes and milestones of today - use this to avoid redundant suggestions and understand the day's overall state.*

{% if resource_daily_context_generator_output.expected_schedule %}
**Expected Schedule:** {{ resource_daily_context_generator_output.expected_schedule }}
{% endif %}

{% if resource_daily_context_generator_output.day_theme %}
**Day Theme:** {{ resource_daily_context_generator_output.day_theme }}
{% endif %}

{% if resource_daily_context_generator_output.current_status %}
**Current Status:** {{ resource_daily_context_generator_output.current_status }}
{% endif %}

{% if resource_daily_context_generator_output.milestones %}
**What's Happened Today:**
{% for milestone in resource_daily_context_generator_output.milestones %}
- {% if milestone.time %}[{{ milestone.time }}]{% endif %} {{ milestone.description }}{% if milestone.ongoing %} (ongoing){% endif %}
{% endfor %}
{% endif %}

---
{% endif %}

{% if recent_chat_messages %}
**Recent Chat:**
{% for msg in recent_chat_messages %}
[{{ msg.time_local }}] {{ msg.sender }}: {{ msg.content }}
{% endfor %}

---
{% endif %}

{% if resource_user_routine or resource_user_health %}
## 1. The Law (User Preferences & Rules)
*Use these resource files as your decision logic. They contain the user's specific rules for timing, limits, and health.*

{% if resource_user_routine and (resource_user_routine.morning or resource_user_routine.work or resource_user_routine.evening) %}
**Routine & Timing Preferences:**
{% if resource_user_routine.morning %}
- **Morning:** Wake up {{ resource_user_routine.morning.wake_up.usual_time }}
  {% for note in resource_user_routine.morning.wake_up.notes %}- {{ note }}
  {% endfor %}
{% endif %}
{% if resource_user_routine.work %}
- **Focus Time:** Best hours are {{ resource_user_routine.work.focus_time.best_hours }}
  {% for note in resource_user_routine.work.focus_time.notes %}- {{ note }}
  {% endfor %}
{% endif %}
{% if resource_user_routine.evening %}
- **Evening:** Family time starts at {{ resource_user_routine.evening.after_work.family_time_start }}
  {% if resource_user_routine.evening.wind_down %}
  Wind-down schedule:
  {% for item in resource_user_routine.evening.wind_down %}
    {% if item.time %}- {{ item.time }}: {{ item.activity }}{% endif %}
    {% if item.preference %}- {{ item.preference }}{% endif %}
    {% if item.goal %}- {{ item.goal }}{% endif %}
  {% endfor %}
  {% endif %}
{% endif %}
{% endif %}

{% if resource_user_health and (resource_user_health.chronic_conditions or resource_user_health.sleep) %}
**Health Conditions & Accommodations:**
{% if resource_user_health.chronic_conditions %}
{% for condition in resource_user_health.chronic_conditions %}
- **{{ condition.display }}** ({{ condition.severity }}): {{ condition.accommodation }} (Every {{ condition.suggested_interval_minutes }} min)
{% endfor %}
{% endif %}
{% if resource_user_health.sleep %}
- **Sleep:** Caffeine cutoff at {{ resource_user_health.sleep.caffeine_cutoff }} ({{ resource_user_health.sleep.caffeine_reason }})
- **Target Bedtime:** {{ resource_user_health.sleep.target_bedtime }}
{% endif %}
{% endif %}

---
{% endif %}

{% if resource_afk_statistics_output or resource_sleep_output or resource_tracked_activities_output %}
## 2. The Facts (System Telemetry)

{% if resource_afk_statistics_output %}
**Computer Presence:**
{% if resource_afk_statistics_output.is_afk %}
[STATUS: AWAY FROM KEYBOARD]
- Idle Time: {{ resource_afk_statistics_output.idle_minutes | default(0) | round | int }} minutes.
- Directive: Do NOT suggest movement or stretches while user is away.
{% else %}
[STATUS: AT KEYBOARD]
- Current Session: {{ resource_afk_statistics_output.current_session_minutes | default(resource_afk_statistics_output.active_work_session_minutes) | default(0) | round(1) }} minutes.
{% endif %}
- Total At Keyboard Since Wake: {{ resource_afk_statistics_output.total_active_time_since_wake | default("unknown") }} minutes.
- Total Away Since Wake: {{ resource_afk_statistics_output.total_afk_time_since_wake | default("unknown") }} minutes.
{% endif %}

{% if resource_sleep_output %}
**Sleep Status:**
- User is up: {{ resource_sleep_output.user_is_up }}
- Day start: {{ resource_sleep_output.day_start_time_local | default("unknown") }}
{% endif %}

{% if resource_tracked_activities_output and resource_tracked_activities_output.activities %}
**Consumption Log (Today):**
{% for key, activity in resource_tracked_activities_output.activities.items() %}
{% if activity.show_daily_count %}
{% set count_field = key ~ "_count_today" %}
{% set mins_field = "minutes_since_" ~ key %}
{% set count_val = time_since[count_field] | default(0) %}
{% set mins_val = time_since[mins_field] | default(none) %}
- {{ activity.display_name | default(key) }}: {{ count_val }} ({% if mins_val is not none %}{{ mins_val | round(1) }} min since last{% else %}N/A{% endif %})
{% endif %}
{% endfor %}

**Activity Timers:**
*Compare these "Time Since" values against the thresholds below.*

**How to interpret thresholds:**
- **Number (e.g., 120 min)**: Suggest when "Time Since" exceeds this value
- **null ("As scheduled", "Max X/day", etc.)**: Use common sense with the description - check calendar events, daily limits, or time windows, NOT the "Time Since" value
- **Important**: It should be **very rare** to suggest an action **before** the threshold is reached. Only do so when there is a clear reason (e.g., acute pain/health override, safety issue, or a strong schedule constraint).

| Activity | Time Since Last | Threshold | Minutes Until Threshold |
| :--- | :--- | :--- | :--- |
{% for key, activity in resource_tracked_activities_output.activities.items() %}
{% set field = "minutes_since_" ~ key %}
{% set mins = time_since[field] | default(none) %}
{% set threshold_mins = activity.threshold_minutes | default(none) %}
{% set threshold_label = threshold_mins if threshold_mins is not none else (activity.guidance | default("N/A")) %}
{% if mins is not none and threshold_mins is not none %}
{% set delta = threshold_mins - mins %}
{% set mins_until = (delta | round(1) ~ " min") if delta > 0 else ("0 min (over by " ~ (delta | abs | round(1)) ~ " min)") %}
{% else %}
{% set mins_until = "N/A" %}
{% endif %}
| {{ activity.display_name }} | {% if mins is not none %}{{ mins | round(1) }} min{% else %}N/A{% endif %} | {{ threshold_label }} | {{ mins_until }} |
{% endfor %}
{% endif %}

---
{% endif %}

## 3. Operational Constraints (The Veto Layer)

{% if calendar_events %}
**Calendar Status:**
[UPCOMING EVENTS]
{% for event in calendar_events %}
- {{ event.start_time }} - {{ event.end_time }}: {{ event.event_name }}
{% endfor %}
*Directive: If an event is starting in <10 mins, suppress complex suggestions.*
{% endif %}

{% if active_tickets %}
**Pending Reminders (DUPLICATE CHECK):**
*Do NOT suggest these types again:*
{% for ticket in active_tickets %}
- [ACTIVE] {{ ticket.suggestion_type }}: {{ ticket.title }}{% if ticket.message %} — {{ ticket.message[:220] }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets and (recent_responded_tickets.accepted or recent_responded_tickets.acknowledged or recent_responded_tickets.declined or recent_responded_tickets.snoozed) %}
**Recent Ticket Responses:**
{% if recent_responded_tickets.accepted %}
*ACCEPTED (User is doing this now or shortly):*
{% for t in recent_responded_tickets.accepted %}
- {{ t.message or t.title }} [Accepted at {{ t.responded_at_local }}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets.acknowledged %}
*ACKNOWLEDGED (User received message, may or may not act. Can nudge again after reasonable time.):*
{% for t in recent_responded_tickets.acknowledged %}
- {{ t.message or t.title }} [Acknowledged at {{ t.responded_at_local }}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets.declined %}
*DECLINED (User not interested. Do not resuggest unless urgent.):*
{% for t in recent_responded_tickets.declined %}
- {{ t.message or t.title }} [Declined at {{ t.responded_at_local }}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets.snoozed %}
*SNOOZED (User wants reminder later. Wait until eligible time.):*
{% for t in recent_responded_tickets.snoozed %}
- {{ t.message or t.title }} [Snoozed at {{ t.responded_at_local }}{% if t.snooze_until_local %}, Eligible again at {{ t.snooze_until_local }}{% endif %}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}
{% endif %}

---

## Your Task
Synthesize the **Rules** (Section 1) with the **Data** (Section 2) to generate a prioritized list of suggestions.

**Output constraints:**
- Do NOT mention "pending reminders" unless you actually output suggestions OR there are active tickets.
- If `resource_sleep_output.user_is_up` is false, do not describe the user as active.

**Logic Checklist:**
2. **Check Rules:** Does `resource_routine_preferences` allow this? (e.g., Check "Coffee Cutoff Time" vs Current Time).
3. **Check Timers:** Is the "Time Since" value high enough based on the User's frequency preferences?
4. **Check Context:** Does `resource_user_health` demand an override? (e.g., "Back Pain" = suggest stretch sooner).
5. **Check Current time:** It is fine to remind user of upcoming things, but check current time vs. time of the event.  How close are they?  Do not
say things like an event 6 hours away is close!
