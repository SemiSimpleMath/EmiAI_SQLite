## Current Time
**{{ date_time }}** ({{ day_of_week }})

{% if previous_state %}
---
## PREVIOUS PLAN STATE (IMPORTANT - maintain continuity!)

**Previous Plan:** {{ previous_state.verbal_plan }}

**Context Block:** {{ previous_state.context_block }}
**Elapsed:** {{ previous_state.elapsed_minutes }} / {{ previous_state.plan_duration_minutes }} minutes
{% if previous_state.current_targets %}
**Current Targets (0-100 sliders):**
- Energy: {{ previous_state.current_targets.energy }}
- Valence: {{ previous_state.current_targets.valence }}
- Loudness: {{ previous_state.current_targets.loudness }}
- Speechiness: {{ previous_state.current_targets.speechiness }}
- Acousticness: {{ previous_state.current_targets.acousticness }}
- Instrumentalness: {{ previous_state.current_targets.instrumentalness }}
- Liveness: {{ previous_state.current_targets.liveness }}
- Tempo: {{ previous_state.current_targets.tempo }}
{% endif %}
{% if previous_state.current_phase_note %}**Current Phase:** {{ previous_state.current_phase_note }}{% endif %}

**CONTINUITY RULE**: Unless something significant changed (health inference, user input, schedule change), your new plan should:
1. Start from the CURRENT targets (0-100 sliders) shown above
2. Continue in the same general direction as the previous plan
3. Not make sudden jumps (typically max +/-10 energy and +/-10 valence from current, unless there is a strong reason)
{% endif %}

---

{% if resource_daily_context_generator_output %}
## Today's Context

### Expected Schedule
```
{{ resource_daily_context_generator_output.expected_schedule }}
```

### Current Status
{{ resource_daily_context_generator_output.current_status }}

### Day Theme
{{ resource_daily_context_generator_output.day_theme }}
{% endif %}

---

{% if resource_health_inference_output %}
## User's Current State (from health inference)

**Mental:**
- Mood: {{ resource_health_inference_output.mental.mood }}
- Stress: {{ resource_health_inference_output.mental.stress_load }}
- Anxiety: {{ resource_health_inference_output.mental.anxiety }}
- Mental Energy: {{ resource_health_inference_output.mental.mental_energy }}

**Physical:**
- Energy Level: {{ resource_health_inference_output.physical.energy_level }}
{% if resource_health_inference_output.physical.pain_level != "none" %}- Pain: {{ resource_health_inference_output.physical.pain_level }}{% endif %}

**Cognitive:**
- Load: {{ resource_health_inference_output.cognitive.load }}
- Focus: {{ resource_health_inference_output.cognitive.focus_depth }}

{% if resource_health_inference_output.general_health_assessment %}
**Assessment:** {{ resource_health_inference_output.general_health_assessment }}
{% endif %}
{% endif %}

---

{% if resource_user_routine %}
## User Routine (patterns to consider)
- Wake: {{ resource_user_routine.morning.wake_up.usual_time }} ({{ resource_user_routine.morning.wake_up.notes | join(', ') }})
- Best focus: {{ resource_user_routine.work.focus_time.best_hours }}
- Family time: {{ resource_user_routine.evening.after_work.family_time_start }}
- Wind-down: {{ resource_user_routine.evening.wind_down[0].time if resource_user_routine.evening.wind_down else 'evening' }}
{% endif %}

---

{% if resource_afk_statistics_output %}
## Computer Presence
{% if resource_afk_statistics_output.at_keyboard %}
[AT KEYBOARD] - Session: {{ resource_afk_statistics_output.current_session_minutes | default(resource_afk_statistics_output.active_work_session_minutes) | default(0) | round(1) }} minutes
{% else %}
[AWAY] - Idle: {{ resource_afk_statistics_output.idle_minutes | default(0) | round | int }} minutes
{% endif %}
{% endif %}

{% if calendar_events %}
## Upcoming Calendar
{% for event in calendar_events %}
- {{ event.event_name }}: {{ event.start_time }} - {{ event.end_time }}
{% endfor %}
{% endif %}

{% if recent_chat %}
## Recent Conversation
{% for msg in recent_chat %}
[{{ msg.time_local }}] {{ msg.sender }}: {{ msg.content }}
{% endfor %}
{% endif %}

---

## Your Task

{% if previous_state %}
**THIS IS A RECHECK** - You have a previous plan and must maintain continuity unless something significant changed.

1. **Check if anything significant changed:**
   - Did user say something that changes the vibe?
   - Did health inference change dramatically?
   - Did the context block change?

2. **If nothing significant changed:**
   - Set `is_continuation: true`
   - Start your new plan from the current 0-100 targets
   - Continue the trajectory smoothly

3. **If something significant changed:**
   - Set `is_continuation: false`
   - Explain what changed in `change_reason`
   - Still try to transition gradually unless it's a dramatic shift (user explicitly requested change)

{% else %}
**THIS IS A NEW PLAN** - No previous state, create fresh.

1. **Identify the current context block** from the expected schedule
2. **Determine when it ends** (the start of the next block, or a reasonable horizon)
3. **Assess current state** from health data
4. **Create a verbal plan** for the next 30-60 minutes
5. **Define 1-3 phases** with numeric targets
{% endif %}

Remember:
- Plan duration should be min(60 minutes, time until context block ends)
- Be realistic about mood changes (valence is 0-100; typical change is ~10-25 points per 30 min unless there is a strong reason)
- Consider user patterns (post-lunch dip, evening wind-down, etc.)
- Honor the mood when appropriate - don't always try to "fix" negative states

If the user explicitly requested a specific kind of music (artist/genre/keyword) in recent chat:
- Set `music_filters` to reflect that request (include_artists/include_genres/include_keywords).

