**Current Time:** {{ date_time }}
**Day:** {{ day_of_week }}

---

{% if resource_user_data %}
## User Context
- **Name:** {{ resource_user_data.preferred_name or resource_user_data.first_name }}
- **Work:** {{ resource_user_data.job }}
{% if resource_user_data.important_people %}
- **Family:** {% for person in resource_user_data.important_people %}{{ person.name }} ({{ person.relationship }}){% if not loop.last %}, {% endif %}{% endfor %}
{% endif %}
{% endif %}

{% if resource_user_routine %}
## Typical Routine (for reference)
- Wake: {{ resource_user_routine.morning.wake_up.usual_time }}
- Focus hours: {{ resource_user_routine.work.focus_time.best_hours }}
- Family time: {{ resource_user_routine.evening.after_work.family_time_start }}
{% endif %}

---

{% if entity_info %}
**Entity Context**:
{{ entity_info }}

---
{% endif %}

{% set mode = daily_context_mode or "incremental" %}
{% set has_theme = current_daily_context.day_theme and current_daily_context.day_theme | length > 0 %}
{% set has_milestones = current_daily_context.milestones and current_daily_context.milestones | length > 0 %}
{% set context_is_empty = not has_theme and not has_milestones %}

## Current Daily Context
{% if mode == "rebuild" or context_is_empty %}
*REBUILD MODE: The daily context is missing or for a different day. Recreate it from scratch using today's calendar + any available chat/tickets.*
{% else %}
*INCREMENTAL MODE: Keep the existing context. Only update if new information materially changes the expected schedule or the day's dominant themes.*

{{ current_daily_context | tojson(indent=2) }}
{% endif %}

{% if calendar_events_upcoming %}
## Calendar Events (included because it is new/changed)
*These are the dominant structure of the day - major commitments and obligations.*
{% for event in calendar_events_upcoming %}
- **{{ event.summary }}** ({{ event.start }} - {{ event.end }})
{% endfor %}
{% endif %}

{% if recent_chat_excerpts %}
## Recent Chat Messages
{% for chat in recent_chat_excerpts %}
- [{{ chat.time_local }}] {{ chat.sender }}: {{ chat.content }}
{% endfor %}
{% endif %}

{% if calendar_events_completed %}
## Completed Calendar Events
{% for event in calendar_events_completed %}
- **{{ event.event_name }}** (ended at {{ event.end_time }})
{% endfor %}
{% endif %}

{% if recent_responded_tickets %}
## Recent Ticket Responses

{% if recent_responded_tickets.accepted %}
### ACCEPTED (User is doing this now or shortly)
{% for t in recent_responded_tickets.accepted %}
- {{ t.message or t.title }} [Accepted at {{ t.responded_at_local }}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets.acknowledged %}
### ACKNOWLEDGED (User received message, may or may not act. Can nudge again after reasonable time.)
{% for t in recent_responded_tickets.acknowledged %}
- {{ t.message or t.title }} [Acknowledged at {{ t.responded_at_local }}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets.declined %}
### DECLINED (User not interested. Do not resuggest unless urgent.)
{% for t in recent_responded_tickets.declined %}
- {{ t.message or t.title }} [Declined at {{ t.responded_at_local }}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% if recent_responded_tickets.snoozed %}
### SNOOZED (User wants reminder later. Wait until eligible time.)
{% for t in recent_responded_tickets.snoozed %}
- {{ t.message or t.title }} [Snoozed at {{ t.responded_at_local }}{% if t.snooze_until_local %}, Eligible again at {{ t.snooze_until_local }}{% endif %}]
{% if t.user_comment %}  User comment: {{ t.user_comment }}{% endif %}
{% endfor %}
{% endif %}

{% endif %}

{% if presence_status %}
## Computer Presence
{% if presence_status.is_afk %}
[STATUS: AWAY FROM KEYBOARD]
- Away Duration: {{ presence_status.duration_minutes }} minutes
{% if presence_status.start_time_local %}- Away Since: {{ presence_status.start_time_local }}{% endif %}
{% else %}
[STATUS: AT KEYBOARD]
- Current Session: {{ presence_status.duration_minutes }} minutes
{% if presence_status.start_time_local %}- At Keyboard Since: {{ presence_status.start_time_local }}{% endif %}
{% endif %}
{% endif %}

{% if activity_segments %}
## Day's Activity Pattern (since wake)
*Significant blocks of activity and AFK (20+ min each). Use this to understand the shape of the day.*
{% for seg in activity_segments %}
- {{ seg }}
{% endfor %}
{% endif %}

